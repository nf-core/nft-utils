nextflow_process {

    name "Test Process curlAndUntar"
    script "./main.nf"
    process "TEST_MODULE"

    tag "test"

    test("test curlAndUntar - tar file") {

        setup {
            curlAndUntar("https://github.com/nf-core/test-datasets/raw/refs/heads/modules/data/genomics/homo_sapiens/genome/index/igblast/igblast_base.tar", "${launchDir}/dbs")
        }
        then {
            def files = getAllFilesFromDir("${launchDir}/dbs")
            assert snapshot(files).match()
        }
        cleanup {
            new File("${launchDir}/dbs").deleteDir()
        }
    }

    test("test curlAndUntar - tar.gz file") {

        setup {
            curlAndUntar("https://github.com/nf-core/test-datasets/raw/refs/heads/modules/data/generic/tar/hello.tar.gz", "${launchDir}/dbs")
        }
        then {
            def expected_file = "${launchDir}/dbs/hello.txt"
            assertAll(
                { assert path(expected_file).exists() },
                { assert snapshot(expected_file).match() },
            )
        }
        cleanup {
            new File("${launchDir}/dbs").deleteDir()
        }
    }

    test("test curlAndUnzip") {

        setup {
            curlAndUnzip("https://github.com/nf-core/test-datasets/raw/refs/heads/modules/data/genomics/sarscov2/genome/db/maltextract/ncbi_taxmap.zip", "${launchDir}/dbs")
        }
        then {
            def expected_file1 = "${launchDir}/dbs/ncbi.tre"
            def expected_file2 = "${launchDir}/dbs/ncbi.map"
            assertAll(
                { assert path(expected_file1).exists() },
                { assert path(expected_file2).exists() },
                { assert snapshot(expected_file1).match("curlAndUnzip:ncbi.tre") },
                { assert snapshot(expected_file2).match("curlAndUnzip:ncbi.map") },
            )
        }
        cleanup {
            new File("${launchDir}/dbs").deleteDir()
        }
    }

    test("test curlAndExtract - tar file") {

        setup {
            curlAndExtract("https://github.com/nf-core/test-datasets/raw/refs/heads/modules/data/genomics/homo_sapiens/genome/index/igblast/igblast_base.tar", "${launchDir}/dbs")
        }
        then {
            def files = getAllFilesFromDir("${launchDir}/dbs")
            assert snapshot(files).match()
        }
        cleanup {
            new File("${launchDir}/dbs").deleteDir()
        }
    }

    test("test curlAndExtract - tar.gz file") {

        setup {
            curlAndExtract("https://github.com/nf-core/test-datasets/raw/refs/heads/modules/data/generic/tar/hello.tar.gz", "${launchDir}/dbs")
        }
        then {
            def expected_file = "${launchDir}/dbs/hello.txt"
            assertAll(
                { assert path(expected_file).exists() },
                { assert snapshot(expected_file).match() },
            )
        }
        cleanup {
            new File("${launchDir}/dbs").deleteDir()
        }
    }

    test("test curlAndExtract - zip file") {

        setup {
            curlAndExtract("https://github.com/nf-core/test-datasets/raw/refs/heads/modules/data/genomics/sarscov2/genome/db/maltextract/ncbi_taxmap.zip", "${launchDir}/dbs")
        }
        then {
            def expected_file1 = "${launchDir}/dbs/ncbi.tre"
            def expected_file2 = "${launchDir}/dbs/ncbi.map"
            assertAll(
                { assert path(expected_file1).exists() },
                { assert path(expected_file2).exists() },
                { assert snapshot(expected_file1).match("curlAndExtract:ncbi.tre") },
                { assert snapshot(expected_file2).match("curlAndExtract:ncbi.map") },
            )
        }
        cleanup {
            new File("${launchDir}/dbs").deleteDir()
        }
    }
}
